<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-bg: #f8f9fa;
            --dark-bg: #1a1a1a;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.08);
            --hover-shadow: 0 8px 25px rgba(0,0,0,0.15);
            --transition: all 0.3s ease;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --light-bg: #1a1a1a;
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --text-color: #ecf0f1;
            --card-bg: #2c3e50;
            --table-bg: #34495e;
            --input-bg: #2c3e50;
            --border-color: #34495e;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color, #333);
            transition: var(--transition);
        }

        /* Animated Header */
        .main-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        /* Enhanced Cards */
        .stats-card {
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border: none;
            margin-bottom: 1.5rem;
            background: white;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .stats-card {
            background: var(--card-bg);
            color: var(--text-color);
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .stats-card:hover::before {
            transform: scaleX(1);
        }

        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--hover-shadow);
        }

        .stats-card .card-body {
            padding: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .stats-card h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .stats-card h3 {
            font-weight: 700;
            margin-bottom: 0;
            font-size: 2rem;
        }

        .stats-card .icon {
            font-size: 2.5rem;
            opacity: 0.8;
            transition: var(--transition);
        }

        .stats-card:hover .icon {
            transform: scale(1.1);
            opacity: 1;
        }

        /* Enhanced Form Section */
        .form-section {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        [data-theme="dark"] .form-section {
            background: var(--card-bg);
        }

        .form-section:hover {
            box-shadow: var(--hover-shadow);
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: var(--transition);
            background: white;
        }

        [data-theme="dark"] .form-control,
        [data-theme="dark"] .form-select {
            background: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
            transform: translateY(-2px);
        }

        .btn {
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        /* Enhanced Table */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        [data-theme="dark"] .table-container {
            background: var(--card-bg);
        }

        .table-container:hover {
            box-shadow: var(--hover-shadow);
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-weight: 600;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 1rem;
        }

        .table tbody tr {
            transition: var(--transition);
            border-radius: 10px;
        }

        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .table tbody td {
            padding: 1rem;
            vertical-align: middle;
        }

        /* Enhanced Status Badges */
        .status-badge {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .status-progress {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        /* Enhanced Buttons */
        .btn-template {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            font-size: 0.85rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn-template:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
        }

        .btn-template i {
            transition: var(--transition);
        }

        .btn-template:hover i {
            transform: translateX(3px);
        }

        /* Enhanced Modal */
        .modal-content {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1.5rem;
        }

        .modal-body {
            background: var(--light-bg);
            border-radius: 0 0 20px 20px;
            padding: 2rem;
        }

        [data-theme="dark"] .modal-body {
            background: var(--card-bg);
        }

        /* Template Container */
        .template-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 1.5rem;
            position: relative;
            transition: var(--transition);
        }

        [data-theme="dark"] .template-container {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .template-container:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .copy-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            transition: var(--transition);
            z-index: 10;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }

        .template-content {
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid var(--secondary-color);
        }

        [data-theme="dark"] .template-content {
            background: var(--input-bg);
            color: var(--text-color);
        }

        /* Enhanced Reason Tags */
        .reason-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            transition: var(--transition);
        }

        .reason-tag:hover {
            transform: scale(1.05);
        }

        .reason-tag i {
            font-size: 0.9rem;
        }

        .reason-wrong {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: #c62828;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.2);
        }

        .reason-missing {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #2e7d32;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
        }

        .reason-delay {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            color: #e65100;
            box-shadow: 0 4px 15px rgba(230, 81, 0, 0.2);
        }

        .reason-quality {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.2);
        }

        .reason-tech {
            background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
            color: #0277bd;
            box-shadow: 0 4px 15px rgba(2, 119, 189, 0.2);
        }

        .reason-hygiene {
            background: linear-gradient(135deg, #fbe9e7, #ffccbc);
            color: #d84315;
            box-shadow: 0 4px 15px rgba(216, 67, 21, 0.2);
        }

        /* Enhanced Company Badges */
        .company-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 0.5rem;
            transition: var(--transition);
        }

        .company-badge:hover {
            transform: scale(1.05);
        }

        .company-badge i {
            font-size: 0.9rem;
        }

        .company-noon {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            box-shadow: 0 4px 15px rgba(21, 101, 192, 0.2);
        }

        .company-careem {
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            color: #c2185b;
            box-shadow: 0 4px 15px rgba(194, 24, 91, 0.2);
        }

        .company-talabat {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
            box-shadow: 0 4px 15px rgba(123, 31, 162, 0.2);
        }

        .company-deliveroo {
            background: linear-gradient(135deg, #e0f2f1, #b2dfdb);
            color: #00796b;
            box-shadow: 0 4px 15px rgba(0, 121, 107, 0.2);
        }

        /* Enhanced Footer */
        .footer {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 3rem;
            position: relative;
            overflow: hidden;
        }

        .footer::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--warning-color), var(--success-color));
        }

        /* Enhanced Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1050;
        }

        .custom-toast {
            background: white;
            color: var(--text-color);
            padding: 1.2rem 1.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            animation: slideIn 0.5s ease-out;
            border-left: 4px solid var(--success-color);
        }

        [data-theme="dark"] .custom-toast {
            background: var(--card-bg);
            border-left-color: var(--success-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%) rotate(-5deg);
                opacity: 0;
            }
            to {
                transform: translateX(0) rotate(0);
                opacity: 1;
            }
        }

        .custom-toast i {
            font-size: 1.8rem;
            margin-left: 1rem;
        }

        .custom-toast.success {
            border-left-color: var(--success-color);
        }

        .custom-toast.warning {
            border-left-color: var(--warning-color);
        }

        .custom-toast.error {
            border-left-color: var(--danger-color);
        }

        /* Enhanced Filter Section */
        .filter-section {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        [data-theme="dark"] .filter-section {
            background: var(--card-bg);
        }

        .filter-section:hover {
            box-shadow: var(--hover-shadow);
        }

        .filter-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .filter-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .filter-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(44, 62, 80, 0.3);
        }

        .filter-btn.active {
            background: var(--primary-color);
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.2);
        }

        /* Enhanced Objection Options */
        .objection-type-selector {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        [data-theme="dark"] .objection-type-selector {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        .objection-option {
            cursor: pointer;
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 12px;
            margin-bottom: 0.8rem;
            transition: var(--transition);
            background: #f8f9fa;
        }

        [data-theme="dark"] .objection-option {
            background: var(--input-bg);
        }

        .objection-option:hover {
            background: rgba(52, 152, 219, 0.1);
            transform: translateX(5px);
        }

        .objection-option.selected {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.15);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
        }

        .objection-option i {
            font-size: 1.8rem;
            margin-left: 0.8rem;
            color: var(--secondary-color);
            transition: var(--transition);
        }

        .objection-option:hover i {
            transform: scale(1.1);
        }

        /* Enhanced Video Evidence Section */
        .video-link-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            border: 2px solid #e0e0e0;
            transition: var(--transition);
        }

        [data-theme="dark"] .video-link-section {
            background: var(--input-bg);
            border-color: var(--border-color);
        }

        .video-link-section:hover {
            border-color: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .video-link-input {
            margin-bottom: 0.8rem;
        }

        .video-link-input label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 50px;
            padding: 0.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: var(--transition);
        }

        [data-theme="dark"] .theme-toggle {
            background: var(--card-bg);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .theme-toggle button {
            border: none;
            background: none;
            font-size: 1.5rem;
            color: var(--primary-color);
            transition: var(--transition);
        }

        .theme-toggle button:hover {
            transform: rotate(180deg);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .stats-card h3 {
                font-size: 1.5rem;
            }
            
            .table-responsive {
                font-size: 0.9rem;
            }
            
            .btn-template {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        /* Hover Effects for Links */
        .image-link {
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.85rem;
            transition: var(--transition);
            position: relative;
        }

        .image-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--secondary-color);
            transition: width 0.3s ease;
        }

        .image-link:hover::after {
            width: 100%;
        }

        .image-link:hover {
            color: var(--primary-color);
        }

        /* Enhanced Badge */
        .badge-video {
            background: linear-gradient(135deg, #0d6efd, #0056b3);
            color: #fff;
            border-radius: 12px;
            padding: 0.3rem 0.8rem;
            font-size: 0.75rem;
            margin-right: 0.8rem;
            box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        /* Animations */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Tooltip Styling */
        .tooltip {
            font-size: 0.85rem;
        }

        /* Focus Styles */
        .btn:focus, .form-control:focus, .form-select:focus {
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        /* Active States */
        .btn:active {
            transform: scale(0.98);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        [data-theme="dark"] .loading-overlay {
            background: rgba(0, 0, 0, 0.9);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button onclick="toggleTheme()" class="btn" title="Toggle Dark Mode">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>
    </div>

    <!-- Header -->
    <header class="main-header fade-in">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0"><i class="bi bi-clipboard-data-fill me-2"></i>Order Management System</h1>
                    <p class="mb-0 mt-2 opacity-75">Professional order tracking with dispute templates</p>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <div class="d-flex align-items-center justify-content-md-end">
                        <div class="me-3">
                            <i class="bi bi-calendar3 me-1"></i>
                            <span id="currentDate"></span>
                        </div>
                        <div>
                            <i class="bi bi-clock me-1"></i>
                            <span id="currentTime"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Statistics Cards -->
        <div class="row slide-up">
            <div class="col-md-3 col-sm-6">
                <div class="card stats-card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Total Orders</h5>
                            <h3 id="totalOrders">0</h3>
                        </div>
                        <div class="icon text-primary">
                            <i class="bi bi-cart3"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stats-card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Adjustments</h5>
                            <h3 id="totalAdjustments">0</h3>
                        </div>
                        <div class="icon text-danger">
                            <i class="bi bi-pencil-square"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stats-card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Total Amount</h5>
                            <h3 id="totalAmount">0 AED</h3>
                        </div>
                        <div class="icon text-success">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6">
                <div class="card stats-card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5>Adjustment Value</h5>
                            <h3 id="adjustmentValue">0 AED</h3>
                        </div>
                        <div class="icon text-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Entry Form -->
        <div class="form-section slide-up">
            <h5 class="mb-3"><i class="bi bi-plus-circle-fill me-2"></i>Add New Order</h5>
            <form id="orderForm">
                <div class="row">
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Reference ID</label>
                            <input type="text" class="form-control" id="refId" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Order Number</label>
                            <input type="text" class="form-control" id="orderNumber" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="datetime-local" class="form-control" id="orderDate" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Branch</label>
                            <select class="form-select" id="branch" required>
                                <option value="">Select Branch</option>
                                <option value="Hamdan St">Hamdan St</option>
                                <option value="Shabiya 11">Shabiya 11</option>
                                <option value="Khaldia">Khaldia</option>
                                <option value="Al Electra">Al Electra</option>
                                <option value="Al Barsha">Al Barsha</option>
                                <option value="Satwa">Satwa</option>
                                <option value="Muroor">Muroor</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Company</label>
                            <select class="form-select" id="company" required>
                                <option value="">Select Company</option>
                                <option value="Noon">Noon</option>
                                <option value="Careem">Careem</option>
                                <option value="Talabat">Talabat</option>
                                <option value="Deliveroo">Deliveroo</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Order Amount</label>
                            <input type="number" class="form-control" id="orderAmount" step="0.01" required>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Adjustment</label>
                            <input type="number" class="form-control" id="adjustment" step="0.01">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Adjustment Reason</label>
                            <select class="form-select" id="adjustmentReason">
                                <option value="">Select Reason</option>
                                <option value="Wrong order or item delivered - Outlet">Wrong order or item delivered</option>
                                <option value="Missing item - Outlet">Missing item</option>
                                <option value="Prep delay Outlet">Preparation delay</option>
                                <option value="Food quality - Outlet (Picture evident)">Food quality (Picture evident)</option>
                                <option value="DT-auto-refund Missing item - Outlet">Auto-refund Missing item</option>
                                <option value="Post-Outlet Tech issue">Post-Outlet Tech issue</option>
                                <option value="Hygiene issues - Outlet">Hygiene issues</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Customer Complaint</label>
                            <textarea class="form-control" id="customerComplaint" rows="1"></textarea>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Video URL</label>
                            <input type="url" class="form-control" id="videoUrl" placeholder="https://...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Video Filename</label>
                            <input type="text" class="form-control" id="videoFilename" placeholder="video.mp4">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="status" required>
                                <option value="Work in Progress">Work in Progress</option>
                                <option value="Resolved">Resolved</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-10 d-flex justify-content-end align-items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i>Add Order
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Filters Section -->
        <div class="filter-section slide-up">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Filter by:</h5>
                </div>
                <div class="col-md-6 text-md-end mt-3 mt-md-0">
                    <button class="filter-btn active" data-filter="all">
                        <i class="bi bi-grid-3x3-gap me-1"></i>All
                    </button>
                    <button class="filter-btn" data-filter="wrong">
                        <i class="bi bi-x-circle me-1"></i>Wrong Order
                    </button>
                    <button class="filter-btn" data-filter="missing">
                        <i class="bi bi-dash-circle me-1"></i>Missing Item
                    </button>
                    <button class="filter-btn" data-filter="delay">
                        <i class="bi bi-clock-history me-1"></i>Delay
                    </button>
                    <button class="filter-btn" data-filter="quality">
                        <i class="bi bi-star-half me-1"></i>Quality
                    </button>
                    <button class="filter-btn" data-filter="tech">
                        <i class="bi bi-gear me-1"></i>Tech Issue
                    </button>
                    <button class="filter-btn" data-filter="hygiene">
                        <i class="bi bi-shield-exclamation me-1"></i>Hygiene
                    </button>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="table-container slide-up">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0"><i class="bi bi-table me-2"></i>Orders & Adjustments</h4>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportToExcel()">
                        <i class="bi bi-download me-1"></i>Export Excel
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportCSV()">
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export CSV
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i>Print Report
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearAllData()">
                        <i class="bi bi-trash me-1"></i>Clear All
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="ordersTable">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Branch</th>
                            <th>Order #</th>
                            <th>Reference</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Adjustment</th>
                            <th>Reason</th>
                            <th>Company</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Orders will be dynamically added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalLabel">
                        <i class="bi bi-envelope-paper-fill me-2"></i>Dispute Template
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Reference ID:</strong></label>
                            <span id="modalRefId" class="form-control-plaintext"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Order Number:</strong></label>
                            <span id="modalOrderId" class="form-control-plaintext"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Branch:</strong></label>
                            <span id="modalBranch" class="form-control-plaintext"></span>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Date:</strong></label>
                            <span id="modalDate" class="form-control-plaintext"></span>
                        </div>
                    </div>
                    
                    <!-- Objection Type Selection -->
                    <div class="objection-type-selector">
                        <h6 class="mb-3"><i class="bi bi-chat-square-text-fill me-2"></i>Select Objection Type:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="objection-option" data-type="pre-prepared" onclick="selectObjectionType(this)">
                                    <i class="bi bi-clock-history"></i>
                                    <strong>Pre-prepared</strong>
                                    <p class="mb-0 small text-muted">Order was ready on time</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="objection-option" data-type="incorrect-complaint" onclick="selectObjectionType(this)">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Incorrect Complaint</strong>
                                    <p class="mb-0 small text-muted">Complaint is not valid</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="objection-option" data-type="clarification" onclick="selectObjectionType(this)">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Clarification</strong>
                                    <p class="mb-0 small text-muted">Need more information</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Company:</strong></label>
                            <select class="form-select" id="modalCompany" onchange="updateTemplateContent()">
                                <option value="Noon">Noon</option>
                                <option value="Careem">Careem</option>
                                <option value="Talabat">Talabat</option>
                                <option value="Deliveroo">Deliveroo</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Adjustment Reason:</strong></label>
                            <span id="modalReason" class="form-control-plaintext"></span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label"><strong>Customer Complaint:</strong></label>
                            <div id="modalComplaint" class="complaint-preview"></div>
                        </div>
                    </div>
                    
                    <!-- Video Evidence Fields -->
                    <div class="row g-3 mb-3">
                        <div class="col-md-8">
                            <label class="form-label"><strong>Video Evidence URL</strong></label>
                            <input id="modalVideoUrl" type="url" class="form-control" placeholder="https://.../evidence.mp4">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><strong>Video Filename (mp4)</strong></label>
                            <input id="modalVideoFilename" type="text" class="form-control" placeholder="evidence.mp4">
                        </div>
                    </div>
                    
                    <div class="template-container">
                        <button class="copy-btn" onclick="copyTemplate()">
                            <i class="bi bi-clipboard me-1"></i>Copy Text
                        </button>
                        <div class="template-content" id="templateContent"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendEmail()">
                        <i class="bi bi-send-fill me-1"></i>Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="mb-0">© 2025 Order Management System - All Rights Reserved</p>
            <p class="mb-0 mt-1 opacity-75">Developed by Restaurant Management Team</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize data
        let orders = [];
        let currentFilter = 'all';
        let selectedObjectionType = 'pre-prepared';
        
        // Templates object
        const templates = {
            noon: {
                subject: 'Objection for Order [REFERENCE]',
                content: `Dear Noon Team,
We are writing to confirm that Order [REFERENCE] from [BRANCH] was fully prepared and accurately handed over to the assigned driver. As evidence, we have attached a video recording that clearly shows the complete order, including all items being transferred. The video also includes accurate timing details for verification.
Adjustment Reason: "[REASON]"
Attached video recording:
[VIDEO_URL]
mp4: [VIDEO_FILENAME]
Visit this link to play the video: [VIDEO_FILENAME]
files.fm`
            },
            wrong: {
                subject: 'Dispute for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are writing to dispute the adjustment for Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

After thorough investigation, we find the customer complaint to be incorrect:

Customer Complaint: [COMPLAINT]

Our internal review shows:
- The order was prepared according to specifications
- All items were included as ordered
- Quality standards were maintained
- The order was complete when handed to the driver

No supporting evidence has been provided to validate this complaint.

We request immediate reversal of this adjustment as it is unjustified.

Best regards,
[BRANCH] Management`
            },
            missing: {
                subject: 'Dispute for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are writing to dispute the adjustment for Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

After thorough investigation, we find the customer complaint to be incorrect:

Customer Complaint: [COMPLAINT]

Our internal review shows:
- The order was prepared with all items included
- All items were properly packaged
- Quality standards were maintained
- The order was complete when handed to the driver

No supporting evidence has been provided to validate this complaint.

We request immediate reversal of this adjustment as it is unjustified.

Best regards,
[BRANCH] Management`
            },
            delay: {
                subject: 'Dispute for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are writing to dispute the adjustment for Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

After thorough investigation, we find the customer complaint to be incorrect:

Customer Complaint: [COMPLAINT]

Our internal review shows:
- The order was prepared within the standard time
- The order was ready for pickup at the scheduled time
- Quality standards were maintained
- The order was handed over to the driver on time

No supporting evidence has been provided to validate this complaint.

We request immediate reversal of this adjustment as it is unjustified.

Best regards,
[BRANCH] Management`
            },
            quality: {
                subject: 'Dispute for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are writing to dispute the adjustment for Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

After thorough investigation, we find the customer complaint to be incorrect:

Customer Complaint: [COMPLAINT]

Our internal review shows:
- The order was prepared according to quality standards
- Fresh ingredients were used
- Proper cooking temperatures were maintained
- Quality checks were performed before packaging

No supporting evidence has been provided to validate this complaint.

We request immediate reversal of this adjustment as it is unjustified.

Best regards,
[BRANCH] Management`
            },
            tech: {
                subject: 'Dispute for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are writing to dispute the adjustment for Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

After thorough investigation, we find the customer complaint to be incorrect:

Customer Complaint: [COMPLAINT]

Our internal review shows:
- The order was prepared and handed over without issues
- Any technical issues occurred after the order left our outlet
- Our systems were functioning properly at the time of order preparation

No supporting evidence has been provided to validate this complaint.

We request immediate reversal of this adjustment as it is unjustified.

Best regards,
[BRANCH] Management`
            },
            hygiene: {
                subject: 'Dispute for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are writing to dispute the adjustment for Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

After thorough investigation, we find the customer complaint to be incorrect:

Customer Complaint: [COMPLAINT]

Our internal review shows:
- The order was prepared following strict hygiene protocols
- Our kitchen maintains high cleanliness standards
- Staff follow proper hygiene procedures
- Regular health inspections are conducted

No supporting evidence has been provided to validate this complaint.

We request immediate reversal of this adjustment as it is unjustified.

Best regards,
[BRANCH] Management`
            },
            clarification: {
                subject: 'Clarification for Order [REFERENCE]',
                content: `Dear [COMPANY] Team,

We are seeking clarification regarding the adjustment made to Order [REFERENCE] (Order #[ORDER_ID]) from [BRANCH] regarding "[REASON]".

Order Details:
- Reference ID: [REFERENCE]
- Order Number: [ORDER_ID]
- Branch: [BRANCH]
- Date: [DATE]

We have received notification of an adjustment but require additional information:

Customer Complaint: [COMPLAINT]

We need clarification on:
- What specific issue was reported?
- Was any evidence provided by the customer?
- Can you share the details of the complaint?
- How does this relate to our outlet's operations?

Our internal records show the order was processed correctly.

Please provide the necessary details so we can investigate this matter thoroughly.

Thank you for your assistance.

Sincerely,
[BRANCH] Team`
            }
        };

        // Load data from LocalStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPersisted();
            loadData();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            updateStatistics();
            renderOrders();
            setupEventListeners();
            
            // Add fade-in animation to elements
            document.querySelectorAll('.fade-in, .slide-up').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    el.style.transition = 'all 0.5s ease';
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                }, 100);
            });
        });

        // Setup event listeners
        function setupEventListeners() {
            // Form submission
            document.getElementById('orderForm').addEventListener('submit', handleFormSubmit);
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    renderOrders();
                    
                    // Add animation to table
                    const tableContainer = document.querySelector('.table-container');
                    tableContainer.style.animation = 'none';
                    setTimeout(() => {
                        tableContainer.style.animation = 'fadeIn 0.5s ease-in';
                    }, 10);
                });
            });
        }

        // Toggle theme
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                themeIcon.className = 'bi bi-moon-fill';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'bi bi-sun-fill';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');
            
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.className = 'bi bi-sun-fill';
            }
        }

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', timeOptions);
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            // Add loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Adding...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                const order = {
                    id: Date.now(),
                    refId: document.getElementById('refId').value,
                    orderNumber: document.getElementById('orderNumber').value,
                    date: document.getElementById('orderDate').value,
                    branch: document.getElementById('branch').value,
                    company: document.getElementById('company').value,
                    amount: parseFloat(document.getElementById('orderAmount').value),
                    adjustment: parseFloat(document.getElementById('adjustment').value) || 0,
                    reason: document.getElementById('adjustmentReason').value,
                    complaint: document.getElementById('customerComplaint').value,
                    videoUrl: document.getElementById('videoUrl').value,
                    videoFilename: document.getElementById('videoFilename').value || getFilenameFromUrl(document.getElementById('videoUrl').value),
                    status: document.getElementById('status').value
                };
                
                orders.push(order);
                saveData();
                renderOrders();
                updateStatistics();
                
                // Reset form
                e.target.reset();
                
                // Restore button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Show success message
                showToast('Order added successfully!', 'success');
                
                // Add animation to new row
                setTimeout(() => {
                    const newRow = document.querySelector('#ordersTableBody tr:first-child');
                    if (newRow) {
                        newRow.style.animation = 'slideUp 0.5s ease-out';
                    }
                }, 100);
            }, 500);
        }

        // Get filename from URL
        function getFilenameFromUrl(url) {
            try {
                if (!url) return '';
                const u = new URL(url);
                const last = u.pathname.split('/').filter(Boolean).pop() || '';
                return last.includes('.') ? last : (last ? last + '.mp4' : '');
            } catch { return ''; }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toISOString().slice(0, 16);
        }

        // Render orders table
        function renderOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            let filteredOrders = orders;
            if (currentFilter !== 'all') {
                filteredOrders = orders.filter(order => {
                    const reason = order.reason.toLowerCase();
                    switch(currentFilter) {
                        case 'wrong': return reason.includes('wrong');
                        case 'missing': return reason.includes('missing');
                        case 'delay': return reason.includes('delay');
                        case 'quality': return reason.includes('quality');
                        case 'tech': return reason.includes('tech');
                        case 'hygiene': return reason.includes('hygiene');
                        default: return true;
                    }
                });
            }
            
            filteredOrders.forEach((order, index) => {
                const row = document.createElement('tr');
                row.style.opacity = '0';
                row.style.transform = 'translateY(20px)';
                row.innerHTML = `
                    <td><span class="status-badge status-progress">${order.status}</span></td>
                    <td>${order.branch}</td>
                    <td>${order.orderNumber}</td>
                    <td>${order.refId}</td>
                    <td>${formatDisplayDate(order.date)}</td>
                    <td>${order.amount.toFixed(2)} AED</td>
                    <td class="adjustment-amount">${order.adjustment ? '-' + order.adjustment.toFixed(2) + ' AED' : '-'}</td>
                    <td>${getReasonBadge(order.reason)}</td>
                    <td>${getCompanyBadge(order.company)}</td>
                    <td class="action-cell">
                        <button class="btn btn-template btn-sm" onclick="openTemplateModal(${order.id})">
                            <i class="bi bi-envelope-paper-fill me-1"></i>Template
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder(${order.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Animate row appearance
                setTimeout(() => {
                    row.style.transition = 'all 0.3s ease';
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0)';
                }, index * 50);
            });
        }

        // Format display date
        function formatDisplayDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get reason badge
        function getReasonBadge(reason) {
            if (!reason) return '-';
            const lowerReason = reason.toLowerCase();
            let className = '';
            let icon = '';
            
            if (lowerReason.includes('wrong')) {
                className = 'reason-wrong';
                icon = 'bi bi-x-circle';
            } else if (lowerReason.includes('missing')) {
                className = 'reason-missing';
                icon = 'bi bi-dash-circle';
            } else if (lowerReason.includes('delay')) {
                className = 'reason-delay';
                icon = 'bi bi-clock-history';
            } else if (lowerReason.includes('quality')) {
                className = 'reason-quality';
                icon = 'bi bi-star-half';
            } else if (lowerReason.includes('tech')) {
                className = 'reason-tech';
                icon = 'bi bi-gear';
            } else if (lowerReason.includes('hygiene')) {
                className = 'reason-hygiene';
                icon = 'bi bi-shield-exclamation';
            }
            
            return `<span class="reason-tag ${className}" title="${reason}"><i class="${icon}"></i>${reason}</span>`;
        }

        // Get company badge
        function getCompanyBadge(company) {
            if (!company) return '-';
            const className = `company-${company.toLowerCase()}`;
            let icon = '';
            
            switch(company.toLowerCase()) {
                case 'noon': icon = 'bi bi-bag-check'; break;
                case 'careem': icon = 'bi bi-car-front'; break;
                case 'talabat': icon = 'bi bi-shop'; break;
                case 'deliveroo': icon = 'bi bi-bicycle'; break;
            }
            
            return `<span class="company-badge ${className}"><i class="${icon}"></i>${company}</span>`;
        }

        // Update statistics
        function updateStatistics() {
            // Add animation to stat cards
            document.querySelectorAll('.stats-card h3').forEach((el, index) => {
                el.style.animation = 'none';
                setTimeout(() => {
                    el.style.animation = 'fadeIn 0.5s ease-in';
                }, index * 100);
            });
            
            document.getElementById('totalOrders').textContent = orders.length;
            
            const adjustments = orders.filter(o => o.adjustment > 0);
            document.getElementById('totalAdjustments').textContent = adjustments.length;
            
            const totalAmount = orders.reduce((sum, o) => sum + o.amount, 0);
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2) + ' AED';
            
            const adjustmentValue = orders.reduce((sum, o) => sum + o.adjustment, 0);
            document.getElementById('adjustmentValue').textContent = '-' + adjustmentValue.toFixed(2) + ' AED';
        }

        // Select objection type
        function selectObjectionType(element) {
            document.querySelectorAll('.objection-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedObjectionType = element.getAttribute('data-type');
            updateTemplateContent();
            
            // Add pulse animation
            element.style.animation = 'pulse 0.5s ease-in-out';
        }

        // Open template modal
        function openTemplateModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            
            // Set modal data
            document.getElementById('modalRefId').textContent = order.refId;
            document.getElementById('modalOrderId').textContent = order.orderNumber;
            document.getElementById('modalBranch').textContent = order.branch;
            document.getElementById('modalDate').textContent = formatDisplayDate(order.date);
            document.getElementById('modalReason').textContent = order.reason || '-';
            document.getElementById('modalCompany').value = order.company || 'Noon';
            
            // Display complaint
            const complaintDiv = document.getElementById('modalComplaint');
            if (order.complaint) {
                complaintDiv.innerHTML = order.complaint;
            } else {
                complaintDiv.innerHTML = 'No customer complaint provided';
            }
            
            // Set video evidence
            const videoUrl = order.videoUrl || '';
            let videoFilename = order.videoFilename || getFilenameFromUrl(videoUrl);
            document.getElementById('modalVideoUrl').value = videoUrl;
            document.getElementById('modalVideoFilename').value = videoFilename;
            
            // Reset objection type selection
            document.querySelectorAll('.objection-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector('.objection-option[data-type="pre-prepared"]').classList.add('selected');
            selectedObjectionType = 'pre-prepared';
            
            // Update template content
            updateTemplateContent();
            
            // Add video badge if video exists
            const hasVideo = !!(videoUrl && videoFilename);
            const modalLabel = document.getElementById('templateModalLabel');
            modalLabel.innerHTML = `<i class="bi bi-envelope-paper-fill me-2"></i>Dispute Template`;
            if (hasVideo) {
                modalLabel.innerHTML += ' <span class="badge-video">Video Attached</span>';
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('templateModal'));
            modal.show();
        }

        // Update template content based on company, objection type, and reason
        function updateTemplateContent() {
            const company = document.getElementById('modalCompany').value;
            const refId = document.getElementById('modalRefId').textContent;
            const orderId = document.getElementById('modalOrderId').textContent;
            const branch = document.getElementById('modalBranch').textContent;
            const date = document.getElementById('modalDate').textContent;
            const reason = document.getElementById('modalReason').textContent;
            const complaint = document.getElementById('modalComplaint').textContent;
            const videoUrl = document.getElementById('modalVideoUrl').value;
            const videoFilename = document.getElementById('modalVideoFilename').value;
            
            let template = '';
            const reasonLower = reason.toLowerCase();
            
            // Select template based on company and objection type
            if (company === 'Noon' && selectedObjectionType === 'pre-prepared') {
                template = templates.noon;
            } else if (selectedObjectionType === 'clarification') {
                template = templates.clarification;
            } else {
                // Select template based on reason type
                if (reasonLower.includes('wrong')) {
                    template = templates.wrong;
                } else if (reasonLower.includes('missing')) {
                    template = templates.missing;
                } else if (reasonLower.includes('delay')) {
                    template = templates.delay;
                } else if (reasonLower.includes('quality')) {
                    template = templates.quality;
                } else if (reasonLower.includes('tech')) {
                    template = templates.tech;
                } else if (reasonLower.includes('hygiene')) {
                    template = templates.hygiene;
                } else {
                    template = templates.wrong; // Default template
                }
            }
            
            // Replace placeholders
            let content = template.content
                .replaceAll('[REFERENCE]', refId)
                .replaceAll('[ORDER_ID]', orderId)
                .replaceAll('[BRANCH]', branch)
                .replaceAll('[DATE]', date)
                .replaceAll('[REASON]', reason)
                .replaceAll('[COMPANY]', company)
                .replaceAll('[COMPLAINT]', complaint)
                .replaceAll('[VIDEO_URL]', videoUrl || '—')
                .replaceAll('[VIDEO_FILENAME]', videoFilename || '—');
            
            document.getElementById('templateContent').textContent = content;
        }

        // Copy template to clipboard
        function copyTemplate() {
            const content = document.getElementById('templateContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                showToast('Text copied successfully!', 'success');
            }).catch(err => {
                showToast('Failed to copy text, please copy manually', 'error');
            });
        }

        // Persist video evidence
        function persistVideoEvidence() {
            const refId = document.getElementById('modalRefId').textContent.trim();
            const videoUrl = document.getElementById('modalVideoUrl').value.trim();
            const videoFilename = document.getElementById('modalVideoFilename').value.trim() || getFilenameFromUrl(videoUrl);
            
            // Update orders array
            const idx = orders.findIndex(o => o.refId === refId);
            if (idx >= 0) {
                orders[idx].videoUrl = videoUrl;
                orders[idx].videoFilename = videoFilename;
            }
            
            // Update video evidence storage
            if (!window.videoEvidence) window.videoEvidence = [];
            const vIdx = window.videoEvidence.findIndex(v => v.reference === refId);
            if (vIdx >= 0) {
                window.videoEvidence[vIdx].videoUrl = videoUrl;
                window.videoEvidence[vIdx].videoFilename = videoFilename;
            } else {
                window.videoEvidence.push({ reference: refId, videoUrl, videoFilename });
            }
            
            // Save to LocalStorage
            localStorage.setItem('videoEvidence', JSON.stringify(window.videoEvidence));
            saveData();
        }

        // Send email (opens default email client)
        function sendEmail() {
            persistVideoEvidence();
            
            const company = document.getElementById('modalCompany').value;
            const content = document.getElementById('templateContent').textContent;
            
            // Get email addresses based on company
            let email = '';
            switch(company) {
                case 'Noon':
                    email = 'support@noon.com';
                    break;
                case 'Careem':
                    email = 'restaurants@careem.com';
                    break;
                case 'Talabat':
                    email = 'support@talabat.com';
                    break;
                case 'Deliveroo':
                    email = 'restaurants@deliveroo.ae';
                    break;
            }
            
            // Create mailto link
            const subject = document.getElementById('templateModalLabel').innerText.replace('Video Attached', '').trim();
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(content)}`;
            
            // Open email client
            window.location.href = mailtoLink;
            
            showToast('Opening email client...', 'success');
            bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
        }

        // Delete order
        function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                // Add fade out animation
                const row = event.target.closest('tr');
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(-100%)';
                
                setTimeout(() => {
                    orders = orders.filter(o => o.id !== orderId);
                    saveData();
                    renderOrders();
                    updateStatistics();
                    showToast('Order deleted successfully!', 'success');
                }, 300);
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                orders = [];
                localStorage.removeItem('orderManagementData');
                localStorage.removeItem('videoEvidence');
                renderOrders();
                updateStatistics();
                showToast('All data cleared!', 'warning');
            }
        }

        // Export to Excel
        function exportToExcel() {
            showToast('Preparing Excel export...', 'success');
            
            setTimeout(() => {
                const ws = XLSX.utils.json_to_sheet(orders.map(o => ({
                    'Reference ID': o.refId,
                    'Order Number': o.orderNumber,
                    'Order Date': formatDisplayDate(o.date),
                    'Branch': o.branch,
                    'Company': o.company,
                    'Order Amount': o.amount,
                    'Adjust Amount': o.adjustment,
                    'Adjustment Reason': o.reason,
                    'Customer Complaint': o.complaint,
                    'Video URL': o.videoUrl || '',
                    'Video Filename': o.videoFilename || '',
                    'Status': o.status
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Orders');
                XLSX.writeFile(wb, 'orders_report.xlsx');
                
                showToast('Excel file exported successfully!', 'success');
            }, 500);
        }

        // Export to CSV
        function exportCSV() {
            showToast('Preparing CSV export...', 'success');
            
            setTimeout(() => {
                const headers = ['Branch', 'OrderId', 'Reference', 'Date', 'Amount', 'Adjustment', 'Reason', 'VideoURL', 'VideoFilename'];
                const data = orders.map(r => ([
                    r.branch, 
                    r.orderNumber, 
                    r.refId, 
                    formatDisplayDate(r.date), 
                    r.amount, 
                    r.adjustment, 
                    r.reason,
                    (r.videoUrl || ''), 
                    (r.videoFilename || '')
                ]));
                
                const csv = [headers, ...data].map(a => 
                    a.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'orders_with_video.csv';
                a.click();
                
                showToast('CSV file exported successfully!', 'success');
            }, 500);
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `custom-toast ${type}`;
            
            const icon = type === 'success' ? 'bi-check-circle-fill' : 
                         type === 'warning' ? 'bi-exclamation-triangle-fill' : 
                         type === 'error' ? 'bi-x-circle-fill' : 'bi-info-circle-fill';
            
            toast.innerHTML = `
                <i class="bi ${icon}"></i>
                <span>${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.transition = 'all 0.3s ease';
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-100%) rotate(-5deg)';
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Save data to LocalStorage
        function saveData() {
            localStorage.setItem('orderManagementData', JSON.stringify(orders));
        }

        // Load data from LocalStorage
        function loadData() {
            const savedData = localStorage.getItem('orderManagementData');
            if (savedData) {
                orders = JSON.parse(savedData);
            }
        }

        // Load persisted video evidence
        function loadPersisted() {
            try {
                window.videoEvidence = JSON.parse(localStorage.getItem('videoEvidence') || '[]');
                loadTheme();
            } catch { 
                window.videoEvidence = []; 
            }
        }
    </script>
</body>
</html>
