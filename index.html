// Data storage
let deliveryData = [];
let deliveryOrders = [];
let goals = {
  monthlySales: 500000,
  branchTargets: {
    'Barsha': 80000,
    'Hamdan': 100000,
    'Khalidiyah': 75000,
    'Muroor': 70000,
    'Satwa': 60000,
    'Shabiya': 90000
  }
};
let alerts = [];
let charts = {};

// Initialize data from provided delivery sales
function initializeData() {
  const branches = ['Barsha', 'Hamdan', 'Khalidiyah', 'Muroor', 'Satwa', 'Shabiya'];
  
  // Convert provided delivery sales to our data structure
  providedDeliverySales.forEach(day => {
    const date = day.Date;
    
    branches.forEach(branch => {
      const shopName = `${branch} Shop`;
      const sales = day[shopName] || 0;
      
      // Generate random orders based on sales (average order value ~50 AED)
      const orders = Math.round(sales / (45 + Math.random() * 10));
      
      deliveryData.push({
        date,
        branch,
        sales,
        orders
      });
    });
  });
  
  // Generate additional data for May-Sep 2025
  const months = ['2025-05', '2025-06', '2025-07', '2025-08', '2025-09'];
  const daysInMonth = [31, 30, 31, 31, 30];
  
  months.forEach((month, monthIdx) => {
    const days = daysInMonth[monthIdx];
    
    for (let day = 1; day <= days; day++) {
      const date = `${month}-${day.toString().padStart(2, '0')}`;
      
      branches.forEach(branch => {
        // Generate realistic sales data with some randomness
        const baseSales = {
          'Barsha': 1500,
          'Hamdan': 3500,
          'Khalidiyah': 1800,
          'Muroor': 1600,
          'Satwa': 800,
          'Shabiya': 1400
        }[branch];
        
        // Add weekend boost and random variation
        const dayOfWeek = new Date(date).getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const weekendMultiplier = isWeekend ? 1.4 : 1;
        
        const sales = Math.round(baseSales * weekendMultiplier * (0.8 + Math.random() * 0.4));
        const orders = Math.round(sales / (45 + Math.random() * 10));
        
        deliveryData.push({
          date,
          branch,
          sales,
          orders
        });
      });
    }
  });
  
  // Sort data by date
  deliveryData.sort((a, b) => new Date(a.date) - new Date(b.date));
  
  // Initialize delivery orders
  deliveryOrders = [...deliveryData];
  
  // Update last updated time
  document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
}

// Update dashboard based on current filters
function updateDashboard() {
  const monthFilter = document.getElementById('monthFilterTop').value;
  const comparePeriod = document.getElementById('comparePeriod').value;
  
  // Filter data based on selected month
  let filteredData = deliveryData;
  if (monthFilter !== 'all') {
    filteredData = deliveryData.filter(item => item.date.startsWith(monthFilter));
  }
  
  // Calculate KPIs
  updateKPIs(filteredData, comparePeriod);
  
  // Update branch cards
  updateBranchCards(filteredData);
  
  // Update charts
  updateCharts(filteredData);
  
  // Update table
  updateTable(filteredData);
  
  // Update insights
  updateInsights(filteredData);
  
  // Update three month report
  updateThreeMonthReport();
  
  // Update goals section
  updateGoalsSection(filteredData);
}

// Update KPI cards
function updateKPIs(data, comparePeriod) {
  // Calculate total sales
  const totalSales = data.reduce((sum, item) => sum + item.sales, 0);
  document.getElementById('kpiSales').textContent = `${totalSales.toLocaleString()} AED`;
  
  // Calculate total orders
  const totalOrders = data.reduce((sum, item) => sum + item.orders, 0);
  document.getElementById('kpiOrders').textContent = totalOrders.toLocaleString();
  
  // Calculate average order value
  const aov = totalOrders > 0 ? totalSales / totalOrders : 0;
  document.getElementById('kpiAOV').textContent = `${aov.toFixed(2)} AED`;
  
  // Calculate growth (compare to previous period)
  const growth = calculateGrowth(data, comparePeriod);
  document.getElementById('kpiOrdersGrowth').textContent = `${growth > 0 ? '+' : ''}${growth.toFixed(1)}%`;
  
  // Update growth badge
  const growthBadge = document.getElementById('kpiOrdersGrowth').parentElement.querySelector('.badge-up, .badge-down');
  if (growthBadge) {
    growthBadge.className = growth >= 0 ? 'small badge-up' : 'small badge-down';
    growthBadge.textContent = `${growth >= 0 ? '+' : ''}${growth.toFixed(1)}%`;
  }
  
  // Find top branch
  const branchSales = {};
  data.forEach(item => {
    if (!branchSales[item.branch]) branchSales[item.branch] = 0;
    branchSales[item.branch] += item.sales;
  });
  
  const topBranch = Object.keys(branchSales).reduce((a, b) => 
    branchSales[a] > branchSales[b] ? a : b, Object.keys(branchSales)[0]);
  
  document.getElementById('kpiTopBranch').textContent = topBranch;
  
  // Find peak day
  const dailySales = {};
  data.forEach(item => {
    if (!dailySales[item.date]) dailySales[item.date] = 0;
    dailySales[item.date] += item.sales;
  });
  
  const peakDay = Object.keys(dailySales).reduce((a, b) => 
    dailySales[a] > dailySales[b] ? a : b, Object.keys(dailySales)[0]);
  
  document.getElementById('kpiPeakDay').textContent = new Date(peakDay).toLocaleDateString();
  document.getElementById('kpiPeakOrders').textContent = dailySales[peakDay].toLocaleString();
}

// Calculate growth percentage
function calculateGrowth(currentData, comparePeriod) {
  if (comparePeriod === 'prev-month') {
    // Get previous month data
    const currentMonth = currentData[0]?.date.substring(0, 7);
    if (!currentMonth) return 0;
    
    const [year, month] = currentMonth.split('-').map(Number);
    const prevMonth = month === 1 ? `${year-1}-12` : `${year}-${(month-1).toString().padStart(2, '0')}`;
    
    const prevData = deliveryData.filter(item => item.date.startsWith(prevMonth));
    const currentTotal = currentData.reduce((sum, item) => sum + item.orders, 0);
    const prevTotal = prevData.reduce((sum, item) => sum + item.orders, 0);
    
    return prevTotal > 0 ? ((currentTotal - prevTotal) / prevTotal) * 100 : 0;
  }
  
  // For other comparison periods, return a random value for demo
  return (Math.random() * 20 - 5); // Between -5% and +15%
}

// Update branch performance cards
function updateBranchCards(data) {
  const branchSales = {};
  const branchOrders = {};
  
  data.forEach(item => {
    if (!branchSales[item.branch]) {
      branchSales[item.branch] = 0;
      branchOrders[item.branch] = 0;
    }
    branchSales[item.branch] += item.sales;
    branchOrders[item.branch] += item.orders;
  });
  
  const branches = Object.keys(branchSales);
  const row1 = document.getElementById('branchRow1');
  const row2 = document.getElementById('branchRow2');
  
  row1.innerHTML = '';
  row2.innerHTML = '';
  
  branches.forEach((branch, index) => {
    const sales = branchSales[branch];
    const orders = branchOrders[branch];
    const target = goals.branchTargets[branch] || 0;
    const progress = target > 0 ? Math.min(100, (sales / target) * 100) : 0;
    
    const card = document.createElement('div');
    card.className = 'card branch-card p-4 drillable';
    card.dataset.branch = branch;
    card.innerHTML = `
      <div class="flex justify-between items-start mb-2">
        <h4 class="font-semibold">${branch}</h4>
        <span class="text-sm ${progress >= 100 ? 'text-green-600' : progress >= 75 ? 'text-yellow-600' : 'text-red-600'}">
          ${progress.toFixed(0)}%
        </span>
      </div>
      <div class="mb-2">
        <div class="text-lg font-bold">${sales.toLocaleString()} AED</div>
        <div class="small text-gray-500">${orders.toLocaleString()} orders</div>
      </div>
      <div class="goal-progress">
        <div class="goal-progress-bar" style="width: ${progress}%"></div>
      </div>
      <div class="small mt-1 text-gray-500">Target: ${target.toLocaleString()} AED</div>
    `;
    
    if (index < 3) {
      row1.appendChild(card);
    } else {
      row2.appendChild(card);
    }
    
    // Add click event for drill-down
    card.addEventListener('click', () => drillDownBranch(branch));
  });
}

// Update charts
function updateCharts(data) {
  // Prepare data for charts
  const branchSales = {};
  const dailySales = {};
  
  data.forEach(item => {
    // Branch sales
    if (!branchSales[item.branch]) branchSales[item.branch] = 0;
    branchSales[item.branch] += item.sales;
    
    // Daily sales
    if (!dailySales[item.date]) dailySales[item.date] = 0;
    dailySales[item.date] += item.sales;
  });
  
  // Bar chart - Sales by Branch
  const barCtx = document.getElementById('barChart').getContext('2d');
  if (charts.barChart) charts.barChart.destroy();
  
  charts.barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(branchSales),
      datasets: [{
        label: 'Delivery Sales (AED)',
        data: Object.values(branchSales),
        backgroundColor: [
          'rgba(215, 38, 61, 0.7)',
          'rgba(242, 183, 5, 0.7)',
          'rgba(16, 185, 129, 0.7)',
          'rgba(59, 130, 246, 0.7)',
          'rgba(139, 92, 246, 0.7)',
          'rgba(236, 72, 153, 0.7)'
        ],
        borderColor: [
          'rgba(215, 38, 61, 1)',
          'rgba(242, 183, 5, 1)',
          'rgba(16, 185, 129, 1)',
          'rgba(59, 130, 246, 1)',
          'rgba(139, 92, 246, 1)',
          'rgba(236, 72, 153, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString() + ' AED';
            }
          }
        }
      }
    }
  });
  
  // Line chart - Daily Sales Trend
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  if (charts.lineChart) charts.lineChart.destroy();
  
  // Get last 30 days for trend
  const sortedDates = Object.keys(dailySales).sort();
  const last30Days = sortedDates.slice(-30);
  const last30Sales = last30Days.map(date => dailySales[date]);
  
  charts.lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: last30Days.map(date => new Date(date).toLocaleDateString()),
      datasets: [{
        label: 'Daily Delivery Sales (AED)',
        data: last30Sales,
        borderColor: 'rgba(215, 38, 61, 1)',
        backgroundColor: 'rgba(215, 38, 61, 0.1)',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toLocaleString() + ' AED';
            }
          }
        }
      }
    }
  });
  
  // Pie chart - Sales Distribution
  const pieCtx = document.getElementById('pieChart').getContext('2d');
  if (charts.pieChart) charts.pieChart.destroy();
  
  charts.pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(branchSales),
      datasets: [{
        data: Object.values(branchSales),
        backgroundColor: [
          'rgba(215, 38, 61, 0.7)',
          'rgba(242, 183, 5, 0.7)',
          'rgba(16, 185, 129, 0.7)',
          'rgba(59, 130, 246, 0.7)',
          'rgba(139, 92, 246, 0.7)',
          'rgba(236, 72, 153, 0.7)'
        ],
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: ${value.toLocaleString()} AED (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

// Update data table
function updateTable(data) {
  const table = $('#dataTable').DataTable();
  table.clear();
  
  data.forEach(item => {
    table.row.add([
      item.date,
      item.branch,
      item.orders,
      item.sales.toFixed(2),
      `<button class="btn btn-icon" onclick="editData('${item.date}', '${item.branch}')">
        <i class="fas fa-edit"></i>
      </button>`
    ]);
  });
  
  table.draw();
}

// Update insights section
function updateInsights(data) {
  const insightsContainer = document.getElementById('insightsContainer');
  insightsContainer.innerHTML = '';
  
  // Calculate some insights
  const totalSales = data.reduce((sum, item) => sum + item.sales, 0);
  const totalOrders = data.reduce((sum, item) => sum + item.orders, 0);
  const aov = totalOrders > 0 ? totalSales / totalOrders : 0;
  
  // Find best performing branch
  const branchSales = {};
  data.forEach(item => {
    if (!branchSales[item.branch]) branchSales[item.branch] = 0;
    branchSales[item.branch] += item.sales;
  });
  
  const bestBranch = Object.keys(branchSales).reduce((a, b) => 
    branchSales[a] > branchSales[b] ? a : b, Object.keys(branchSales)[0]);
  
  // Find worst performing branch
  const worstBranch = Object.keys(branchSales).reduce((a, b) => 
    branchSales[a] < branchSales[b] ? a : b, Object.keys(branchSales)[0]);
  
  // Create insights
  const insights = [
    {
      type: 'success',
      icon: 'fa-chart-line',
      title: 'Strong Sales Performance',
      context: `Total delivery sales reached ${totalSales.toLocaleString()} AED with ${totalOrders.toLocaleString()} orders.`,
      recommendation: 'Continue current marketing strategies to maintain momentum.'
    },
    {
      type: 'info',
      icon: 'fa-store',
      title: 'Top Performing Branch',
      context: `${bestBranch} branch leads with ${branchSales[bestBranch].toLocaleString()} AED in sales.`,
      recommendation: 'Analyze successful strategies at this branch and replicate across other locations.'
    },
    {
      type: 'warning',
      icon: 'fa-exclamation-triangle',
      title: 'Branch Performance Gap',
      context: `${worstBranch} branch underperformed with ${branchSales[worstBranch].toLocaleString()} AED in sales.`,
      recommendation: 'Review operations and marketing efforts at this branch.'
    },
    {
      type: 'info',
      icon: 'fa-receipt',
      title: 'Average Order Value',
      context: `AOV is ${aov.toFixed(2)} AED, which is ${aov > 50 ? 'above' : 'below'} target.`,
      recommendation: aov > 50 ? 'Maintain current pricing strategy.' : 'Consider upselling techniques to increase AOV.'
    }
  ];
  
  // Add insights to container
  insights.forEach(insight => {
    const insightItem = document.createElement('div');
    insightItem.className = `insight-item ${insight.type}`;
    insightItem.innerHTML = `
      <div class="insight-header">
        <div class="insight-icon ${insight.type}">
          <i class="fas ${insight.icon}"></i>
        </div>
        <div>
          <div class="insight-title">${insight.title}</div>
          <div class="insight-context">${insight.context}</div>
        </div>
      </div>
      <div class="insight-recommendation">
        <strong>Recommendation:</strong> ${insight.recommendation}
      </div>
      <div class="insight-actions">
        <span class="insight-action primary">Take Action</span>
        <span class="insight-action secondary">Dismiss</span>
      </div>
    `;
    
    insightsContainer.appendChild(insightItem);
  });
  
  // Update insight count
  document.getElementById('insightCount').textContent = `${insights.length} insights`;
}

// Update three month report
function updateThreeMonthReport() {
  const container = document.getElementById('threeMonthReportContainer');
  container.innerHTML = '';
  
  // Get last 3 months
  const months = ['2025-07', '2025-08', '2025-09'];
  const monthNames = ['July', 'August', 'September'];
  
  months.forEach((month, index) => {
    const monthData = deliveryData.filter(item => item.date.startsWith(month));
    const totalSales = monthData.reduce((sum, item) => sum + item.sales, 0);
    const totalOrders = monthData.reduce((sum, item) => sum + item.orders, 0);
    
    // Calculate branch performance
    const branchSales = {};
    monthData.forEach(item => {
      if (!branchSales[item.branch]) branchSales[item.branch] = 0;
      branchSales[item.branch] += item.sales;
    });
    
    // Sort branches by sales
    const sortedBranches = Object.keys(branchSales).sort((a, b) => 
      branchSales[b] - branchSales[a]);
    
    const reportCard = document.createElement('div');
    reportCard.className = 'report-card';
    reportCard.innerHTML = `
      <div class="report-header">
        <div>
          <div class="report-title">${monthNames[index]} 2025 Report</div>
          <div class="report-period">${monthNames[index]} 1-31, 2025</div>
        </div>
        <div class="text-right">
          <div class="text-lg font-bold">${totalSales.toLocaleString()} AED</div>
          <div class="small text-gray-500">${totalOrders.toLocaleString()} orders</div>
        </div>
      </div>
      
      <table class="report-table">
        <thead>
          <tr>
            <th>Branch</th>
            <th>Sales (AED)</th>
            <th>Orders</th>
            <th>AOV (AED)</th>
            <th>Growth</th>
          </tr>
        </thead>
        <tbody>
          ${sortedBranches.map(branch => {
            const sales = branchSales[branch];
            const orders = monthData.filter(item => item.branch === branch)
              .reduce((sum, item) => sum + item.orders, 0);
            const aov = orders > 0 ? sales / orders : 0;
            
            // Calculate growth (random for demo)
            const growth = (Math.random() * 20 - 5);
            const growthClass = growth >= 0 ? 'growth-positive' : 'growth-negative';
            const growthIcon = growth >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            
            return `
              <tr>
                <td>${branch}</td>
                <td>${sales.toLocaleString()}</td>
                <td>${orders.toLocaleString()}</td>
                <td>${aov.toFixed(2)}</td>
                <td class="${growthClass}">
                  <i class="fas ${growthIcon}"></i> ${Math.abs(growth).toFixed(1)}%
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      
      <div class="branch-summary">
        <div class="branch-performance">
          <span class="performance-indicator performance-up"></span>
          <span>Best performer: ${sortedBranches[0]}</span>
        </div>
        <div class="report-actions">
          <button class="report-action primary">View Details</button>
          <button class="report-action secondary">Export</button>
        </div>
      </div>
    `;
    
    container.appendChild(reportCard);
  });
}

// Update goals section
function updateGoalsSection(data) {
  const monthFilter = document.getElementById('monthFilterTop').value;
  let currentMonth = '2025-09';
  
  if (monthFilter !== 'all') {
    currentMonth = monthFilter;
  }
  
  const monthData = data.filter(item => item.date.startsWith(currentMonth));
  const monthlySales = monthData.reduce((sum, item) => sum + item.sales, 0);
  const progress = Math.min(100, (monthlySales / goals.monthlySales) * 100);
  
  document.getElementById('monthlyTarget').textContent = `${goals.monthlySales.toLocaleString()} AED`;
  document.getElementById('monthlyProgress').textContent = `${progress.toFixed(0)}%`;
  document.getElementById('monthlyProgressBar').style.width = `${progress}%`;
  
  // Update branch ranking
  const branchOrders = {};
  monthData.forEach(item => {
    if (!branchOrders[item.branch]) branchOrders[item.branch] = 0;
    branchOrders[item.branch] += item.orders;
  });
  
  const sortedBranches = Object.keys(branchOrders).sort((a, b) => 
    branchOrders[b] - branchOrders[a]);
  
  const rankingHTML = sortedBranches.slice(0, 3).map((branch, index) => `
    <div class="flex justify-between py-1">
      <span>${index + 1}. ${branch}</span>
      <span class="font-semibold">${branchOrders[branch].toLocaleString()} orders</span>
    </div>
  `).join('');
  
  document.getElementById('branchRanking').innerHTML = rankingHTML;
  
  // Update performance alerts
  const alerts = [];
  sortedBranches.forEach(branch => {
    const sales = monthData.filter(item => item.branch === branch)
      .reduce((sum, item) => sum + item.sales, 0);
    const target = goals.branchTargets[branch] || 0;
    
    if (target > 0 && sales < target * 0.8) {
      alerts.push(`${branch} below target`);
    }
  });
  
  const alertsHTML = alerts.length > 0 
    ? alerts.map(alert => `
        <div class="flex items-center gap-2 py-1">
          <span class="w-2 h-2 rounded-full bg-red-500"></span>
          <span>${alert}</span>
        </div>
      `).join('')
    : `
        <div class="flex items-center gap-2 py-1">
          <span class="w-2 h-2 rounded-full bg-green-500"></span>
          <span>All branches on track</span>
        </div>
      `;
  
  document.getElementById('performanceAlerts').innerHTML = alertsHTML;
}

// Initialize DataTable
function initializeTable() {
  $('#dataTable').DataTable({
    responsive: true,
    pageLength: 10,
    order: [[0, 'desc']]
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Initialize data
  initializeData();
  
  // Initialize table
  initializeTable();
  
  // Initial dashboard update
  updateDashboard();
  
  // Month filter change
  document.getElementById('monthFilterTop').addEventListener('change', updateDashboard);
  document.getElementById('mobileMonthFilter').addEventListener('change', function() {
    document.getElementById('monthFilterTop').value = this.value;
    updateDashboard();
  });
  
  // Compare period change
  document.getElementById('comparePeriod').addEventListener('change', updateDashboard);
  document.getElementById('mobileComparePeriod').addEventListener('change', function() {
    document.getElementById('comparePeriod').value = this.value;
    updateDashboard();
  });
  
  // Export buttons
  document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
  document.getElementById('btnExportPDF').addEventListener('click', exportPDF);
  document.getElementById('btnExportExcel').addEventListener('click', exportExcel);
  
  // Schedule export
  document.getElementById('btnScheduleExport').addEventListener('click', showScheduleModal);
  document.getElementById('mobileControls').querySelector('button[onclick="showScheduleModal()"]').addEventListener('click', showScheduleModal);
  
  // Present mode
  document.getElementById('btnPresentMode').addEventListener('click', enterPresentMode);
  document.getElementById('mobileControls').querySelector('button[onclick="enterPresentMode()"]').addEventListener('click', enterPresentMode);
  
  // Dark mode
  document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
  document.getElementById('mobileControls').querySelector('button[onclick="toggleDarkMode()"]').addEventListener('click', toggleDarkMode);
  
  // Tour
  document.getElementById('btnTour').addEventListener('click', startTour);
  document.getElementById('mobileControls').querySelector('button[onclick="startTour()"]').addEventListener('click', startTour);
  
  // Alerts
  document.getElementById('btnAlerts').addEventListener('click', showAlertModal);
  document.getElementById('mobileControls').querySelector('button[onclick="showAlertModal()"]').addEventListener('click', showAlertModal);
  
  // Reset and clear
  document.getElementById('btnReset').addEventListener('click', resetData);
  document.getElementById('btnClearAll').addEventListener('click', clearAllData);
  document.getElementById('mobileControls').querySelector('button[onclick="resetData()"]').addEventListener('click', resetData);
  document.getElementById('mobileControls').querySelector('button[onclick="clearAllData()"]').addEventListener('click', clearAllData);
  
  // Data input
  document.getElementById('btnUpdate').addEventListener('click', updateDataFromInput);
  document.getElementById('btnClearInput').addEventListener('click', clearDataInput);
  document.getElementById('btnSetGoals').addEventListener('click', showGoalModal);
  
  // Refresh insights
  document.getElementById('refreshReport').addEventListener('click', function() {
    showNotification('Report refreshed successfully', 'success');
    updateThreeMonthReport();
  });
  
  // Apply filters
  document.getElementById('applyFilters').addEventListener('click', function() {
    showNotification('Filters applied successfully', 'success');
    updateDashboard();
  });
  
  // Modal close buttons
  document.getElementById('closeDrillModal').addEventListener('click', closeDrillModal);
  document.getElementById('closeGoalModal').addEventListener('click', closeGoalModal);
  document.getElementById('closeAlertModal').addEventListener('click', closeAlertModal);
  document.getElementById('closeScheduleModal').addEventListener('click', closeScheduleModal);
  
  // Save goals
  document.getElementById('saveGoals').addEventListener('click', saveGoals);
  document.getElementById('cancelGoals').addEventListener('click', closeGoalModal);
  
  // Save alert
  document.getElementById('saveAlert').addEventListener('click', saveAlert);
  document.getElementById('cancelAlert').addEventListener('click', closeAlertModal);
  
  // Save schedule
  document.getElementById('saveSchedule').addEventListener('click', saveSchedule);
  document.getElementById('cancelSchedule').addEventListener('click', closeScheduleModal);
  
  // Refresh insights
  document.querySelector('button[onclick="refreshInsights()"]').addEventListener('click', function() {
    showNotification('Insights refreshed successfully', 'success');
    updateInsights(deliveryData);
  });
  
  // Initialize tour steps
  initializeTour();
});

// Mobile menu toggle
function toggleMobileMenu() {
  const mobileControls = document.getElementById('mobileControls');
  const overlay = document.querySelector('.mobile-controls-overlay');
  
  mobileControls.classList.toggle('active');
  overlay.classList.toggle('active');
}

// Export functions
function exportCSV() {
  showNotification('Preparing CSV export...', 'info');
  
  setTimeout(() => {
    const monthFilter = document.getElementById('monthFilterTop').value;
    let data = deliveryData;
    
    if (monthFilter !== 'all') {
      data = deliveryData.filter(item => item.date.startsWith(monthFilter));
    }
    
    let csv = 'Date,Branch,Orders,Sales (AED)\n';
    data.forEach(item => {
      csv += `${item.date},${item.branch},${item.orders},${item.sales}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `crispy_chicken_delivery_${monthFilter}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('CSV exported successfully', 'success');
  }, 1000);
}

function exportPDF() {
  showNotification('Preparing PDF export...', 'info');
  
  setTimeout(() => {
    // In a real implementation, you would use jsPDF to generate a PDF
    // For this demo, we'll just show a notification
    showNotification('PDF exported successfully', 'success');
  }, 1500);
}

function exportExcel() {
  showNotification('Preparing Excel export...', 'info');
  
  setTimeout(() => {
    const monthFilter = document.getElementById('monthFilterTop').value;
    let data = deliveryData;
    
    if (monthFilter !== 'all') {
      data = deliveryData.filter(item => item.date.startsWith(monthFilter));
    }
    
    // Convert data to worksheet
    const ws = XLSX.utils.json_to_sheet(data.map(item => ({
      'Date': item.date,
      'Branch': item.branch,
      'Orders': item.orders,
      'Sales (AED)': item.sales
    })));
    
    // Create workbook and add worksheet
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Delivery Data');
    
    // Save file
    XLSX.writeFile(wb, `crispy_chicken_delivery_${monthFilter}.xlsx`);
    
    showNotification('Excel exported successfully', 'success');
  }, 1500);
}

// Modal functions
function showScheduleModal() {
  document.getElementById('scheduleModal').classList.add('active');
}

function closeScheduleModal() {
  document.getElementById('scheduleModal').classList.remove('active');
}

function saveSchedule() {
  const format = document.getElementById('exportFormat').value;
  const frequency = document.getElementById('exportFrequency').value;
  const time = document.getElementById('exportTime').value;
  const recipients = document.getElementById('exportRecipients').value;
  
  // In a real app, you would save this to a database
  showNotification(`Export scheduled: ${format} report ${frequency} at ${time}`, 'success');
  closeScheduleModal();
}

function enterPresentMode() {
  document.body.classList.add('present-mode');
  showNotification('Present mode activated. Press ESC to exit.', 'info');
  
  // Exit on ESC key
  const exitPresent = function(e) {
    if (e.key === 'Escape') {
      document.body.classList.remove('present-mode');
      document.removeEventListener('keydown', exitPresent);
      showNotification('Exited present mode', 'info');
    }
  };
  
  document.addEventListener('keydown', exitPresent);
}

function toggleDarkMode() {
  document.body.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  showNotification(`Dark mode ${isDark ? 'enabled' : 'disabled'}`, 'info');
}

function startTour() {
  tour.start();
}

function initializeTour() {
  tour.addStep({
    title: 'Welcome to Crispy Chicken Dashboard',
    text: 'This dashboard provides insights into your delivery sales performance.',
    attachTo: { element: '.header-content', on: 'bottom' },
    buttons: [
      { text: 'Next', action: tour.next }
    ]
  });
  
  tour.addStep({
    title: 'Key Performance Indicators',
    text: 'These cards show your most important metrics at a glance.',
    attachTo: { element: '.kpi-row', on: 'bottom' },
    buttons: [
      { text: 'Previous', action: tour.back },
      { text: 'Next', action: tour.next }
    ]
  });
  
  tour.addStep({
    title: 'Branch Performance',
    text: 'See how each branch is performing against its targets.',
    attachTo: { element: '.branch-card', on: 'top' },
    buttons: [
      { text: 'Previous', action: tour.back },
      { text: 'Next', action: tour.next }
    ]
  });
  
  tour.addStep({
    title: 'Sales Charts',
    text: 'Visualize your sales data with these interactive charts.',
    attachTo: { element: '.charts-grid', on: 'top' },
    buttons: [
      { text: 'Previous', action: tour.back },
      { text: 'Next', action: tour.next }
    ]
  });
  
  tour.addStep({
    title: 'Data Management',
    text: 'Update your data or export reports from this section.',
    attachTo: { element: '#dataTable', on: 'top' },
    buttons: [
      { text: 'Previous', action: tour.back },
      { text: 'Finish', action: tour.complete }
    ]
  });
}

function showAlertModal() {
  document.getElementById('alertModal').classList.add('active');
  
  // Load active alerts
  const activeAlertsList = document.getElementById('activeAlertsList');
  activeAlertsList.innerHTML = '';
  
  if (alerts.length === 0) {
    activeAlertsList.innerHTML = '<div class="text-center py-4 text-gray-500">No active alerts</div>';
  } else {
    alerts.forEach((alert, index) => {
      const alertItem = document.createElement('div');
      alertItem.className = 'alert-list-item';
      alertItem.innerHTML = `
        <div class="alert-list-info">
          <div class="alert-list-name">${alert.name}</div>
          <div class="alert-list-details">${alert.type} â€¢ ${alert.threshold} AED</div>
        </div>
        <div class="alert-list-actions">
          <button class="alert-list-btn toggle ${alert.active ? 'active' : ''}" onclick="toggleAlert(${index})">
            ${alert.active ? 'Active' : 'Inactive'}
          </button>
          <button class="alert-list-btn edit" onclick="editAlert(${index})">
            <i class="fas fa-edit"></i>
          </button>
          <button class="alert-list-btn delete" onclick="deleteAlert(${index})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      activeAlertsList.appendChild(alertItem);
    });
  }
}

function closeAlertModal() {
  document.getElementById('alertModal').classList.remove('active');
}

function saveAlert() {
  const name = document.getElementById('alertName').value;
  const type = document.getElementById('alertType').value;
  const threshold = document.getElementById('alertThreshold').value;
  
  if (!name || !threshold) {
    showNotification('Please fill in all required fields', 'error');
    return;
  }
  
  // Get selected branches
  const branchCheckboxes = document.querySelectorAll('#alertBranches input[type="checkbox"]:checked');
  const branches = Array.from(branchCheckboxes).map(cb => cb.value);
  
  // Add alert
  alerts.push({
    name,
    type,
    threshold: parseFloat(threshold),
    branches,
    method: document.getElementById('alertMethod').value,
    frequency: document.getElementById('alertFrequency').value,
    active: true
  });
  
  showNotification('Alert created successfully', 'success');
  closeAlertModal();
}

function toggleAlert(index) {
  alerts[index].active = !alerts[index].active;
  showAlertModal();
}

function editAlert(index) {
  // In a real app, you would populate the form with the alert data
  showNotification('Edit functionality would open here', 'info');
}

function deleteAlert(index) {
  alerts.splice(index, 1);
  showAlertModal();
  showNotification('Alert deleted successfully', 'success');
}

function showGoalModal() {
  document.getElementById('goalModal').classList.add('active');
  
  // Populate form with current goals
  document.getElementById('goalModalContent').innerHTML = `
    <div class="mb-4">
      <label class="form-label">Monthly Sales Target (AED)</label>
      <input type="number" id="monthlySalesTarget" class="form-input" value="${goals.monthlySales}">
    </div>
    
    <h4 class="font-medium mb-3">Branch Targets</h4>
    <div class="space-y-3">
      ${Object.keys(goals.branchTargets).map(branch => `
        <div class="flex items-center justify-between">
          <label class="form-label mb-0">${branch}</label>
          <input type="number" class="form-input w-32" value="${goals.branchTargets[branch]}" 
                 data-branch="${branch}">
        </div>
      `).join('')}
    </div>
  `;
}

function closeGoalModal() {
  document.getElementById('goalModal').classList.remove('active');
}

function saveGoals() {
  // Update monthly target
  goals.monthlySales = parseFloat(document.getElementById('monthlySalesTarget').value);
  
  // Update branch targets
  document.querySelectorAll('#goalModalContent input[data-branch]').forEach(input => {
    const branch = input.dataset.branch;
    goals.branchTargets[branch] = parseFloat(input.value);
  });
  
  showNotification('Goals saved successfully', 'success');
  closeGoalModal();
  updateDashboard();
}

function resetData() {
  if (confirm('Are you sure you want to reset all data to initial state?')) {
    initializeData();
    updateDashboard();
    showNotification('Data reset successfully', 'success');
  }
}

function clearAllData() {
  if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
    deliveryData = [];
    deliveryOrders = [];
    updateDashboard();
    showNotification('All data cleared', 'warning');
  }
}

function updateDataFromInput() {
  const input = document.getElementById('dataInput').value.trim();
  if (!input) {
    showNotification('Please enter data to update', 'error');
    return;
  }
  
  try {
    const lines = input.split('\n');
    let updated = 0;
    
    lines.forEach(line => {
      const [date, outlet, orders, sales] = line.split(',').map(item => item.trim());
      
      if (date && outlet && orders && sales) {
        const branch = branchMapping[outlet] || outlet;
        
        // Find existing record
        const existingIndex = deliveryData.findIndex(item => 
          item.date === date && item.branch === branch);
        
        if (existingIndex !== -1) {
          // Update existing record
          deliveryData[existingIndex].orders = parseInt(orders);
          deliveryData[existingIndex].sales = parseFloat(sales);
          updated++;
        } else {
          // Add new record
          deliveryData.push({
            date,
            branch,
            orders: parseInt(orders),
            sales: parseFloat(sales)
          });
          updated++;
        }
      }
    });
    
    if (updated > 0) {
      updateDashboard();
      showNotification(`${updated} records updated successfully`, 'success');
      clearDataInput();
    } else {
      showNotification('No valid data found to update', 'error');
    }
  } catch (error) {
    showNotification('Error parsing data. Please check your format.', 'error');
  }
}

function clearDataInput() {
  document.getElementById('dataInput').value = '';
}

function drillDownBranch(branch) {
  const modal = document.getElementById('drillModal');
  const content = document.getElementById('drillModalContent');
  
  // Get branch data
  const branchData = deliveryData.filter(item => item.branch === branch);
  
  // Calculate metrics
  const totalSales = branchData.reduce((sum, item) => sum + item.sales, 0);
  const totalOrders = branchData.reduce((sum, item) => sum + item.orders, 0);
  const aov = totalOrders > 0 ? totalSales / totalOrders : 0;
  
  // Find best and worst days
  const dailySales = {};
  branchData.forEach(item => {
    if (!dailySales[item.date]) dailySales[item.date] = 0;
    dailySales[item.date] += item.sales;
  });
  
  const sortedDays = Object.keys(dailySales).sort((a, b) => dailySales[b] - dailySales[a]);
  const bestDay = sortedDays[0];
  const worstDay = sortedDays[sortedDays.length - 1];
  
  // Update drill path
  updateDrillPath('Branch', branch);
  
  // Populate modal content
  content.innerHTML = `
    <div class="mb-6">
      <h4 class="text-xl font-bold mb-2">${branch} Branch Details</h4>
      <div class="grid grid-cols-2 gap-4">
        <div class="card p-3">
          <div class="text-sm text-gray-500">Total Sales</div>
          <div class="text-lg font-bold">${totalSales.toLocaleString()} AED</div>
        </div>
        <div class="card p-3">
          <div class="text-sm text-gray-500">Total Orders</div>
          <div class="text-lg font-bold">${totalOrders.toLocaleString()}</div>
        </div>
        <div class="card p-3">
          <div class="text-sm text-gray-500">Average Order Value</div>
          <div class="text-lg font-bold">${aov.toFixed(2)} AED</div>
        </div>
        <div class="card p-3">
          <div class="text-sm text-gray-500">Performance</div>
          <div class="text-lg font-bold">
            ${totalSales >= goals.branchTargets[branch] ? 'Above Target' : 'Below Target'}
          </div>
        </div>
      </div>
    </div>
    
    <div class="mb-6">
      <h5 class="font-semibold mb-3">Performance Highlights</h5>
      <div class="space-y-2">
        <div class="flex justify-between">
          <span>Best Day:</span>
          <span class="font-medium">${new Date(bestDay).toLocaleDateString()} (${dailySales[bestDay].toLocaleString()} AED)</span>
        </div>
        <div class="flex justify-between">
          <span>Slowest Day:</span>
          <span class="font-medium">${new Date(worstDay).toLocaleDateString()} (${dailySales[worstDay].toLocaleString()} AED)</span>
        </div>
        <div class="flex justify-between">
          <span>Target Achievement:</span>
          <span class="font-medium">${((totalSales / goals.branchTargets[branch]) * 100).toFixed(1)}%</span>
        </div>
      </div>
    </div>
    
    <div>
      <h5 class="font-semibold mb-3">Recent Performance</h5>
      <div class="table-container">
        <table class="w-full text-sm">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 text-left">Date</th>
              <th class="p-2 text-right">Orders</th>
              <th class="p-2 text-right">Sales (AED)</th>
            </tr>
          </thead>
          <tbody>
            ${branchData.slice(-10).reverse().map(item => `
              <tr>
                <td class="p-2">${new Date(item.date).toLocaleDateString()}</td>
                <td class="p-2 text-right">${item.orders}</td>
                <td class="p-2 text-right">${item.sales.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  modal.classList.add('active');
}

function closeDrillModal() {
  document.getElementById('drillModal').classList.remove('active');
  resetDrillPath();
}

function updateDrillPath(level, value) {
  const drillPath = document.getElementById('drillPath');
  drillPath.style.display = 'flex';
  
  // Add new item to path
  const pathItem = document.createElement('div');
  pathItem.className = 'drill-path-item';
  pathItem.textContent = value;
  pathItem.dataset.level = drillPath.children.length;
  pathItem.addEventListener('click', function() {
    // In a real app, this would navigate back to this level
    showNotification(`Navigating to ${level}: ${value}`, 'info');
  });
  
  drillPath.appendChild(pathItem);
  
  // Update active state
  drillPath.querySelectorAll('.drill-path-item').forEach(item => {
    item.classList.remove('active');
  });
  pathItem.classList.add('active');
}

function resetDrillPath() {
  const drillPath = document.getElementById('drillPath');
  drillPath.style.display = 'none';
  drillPath.innerHTML = `
    <span class="small">Drill-down path:</span>
    <div class="drill-path-item active" data-level="0">Dashboard</div>
  `;
}

function editData(date, branch) {
  const record = deliveryData.find(item => item.date === date && item.branch === branch);
  if (!record) return;
  
  const newOrders = prompt('Enter new number of orders:', record.orders);
  if (newOrders !== null && !isNaN(newOrders)) {
    const newSales = prompt('Enter new sales amount (AED):', record.sales);
    if (newSales !== null && !isNaN(newSales)) {
      record.orders = parseInt(newOrders);
      record.sales = parseFloat(newSales);
      updateDashboard();
      showNotification('Data updated successfully', 'success');
    }
  }
}

function refreshInsights() {
  showNotification('Refreshing insights...', 'info');
  setTimeout(() => {
    updateInsights(deliveryData);
    showNotification('Insights refreshed successfully', 'success');
  }, 1000);
}

function showNotification(message, type = 'info') {
  const container = document.getElementById('notificationContainer');
  
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  
  container.appendChild(notification);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      container.removeChild(notification);
    }, 300);
  }, 3000);
}

// Add some sample alerts
alerts.push(
  {
    name: 'Low Sales Alert',
    type: 'sales',
    threshold: 1000,
    branches: ['Barsha', 'Satwa'],
    method: 'popup',
    frequency: 'daily',
    active: true
  },
  {
    name: 'High Growth Alert',
    type: 'growth',
    threshold: 15,
    branches: ['Hamdan', 'Shabiya'],
    method: 'email',
    frequency: 'weekly',
    active: true
  }
);
